# Redis开发与运维-note\(三\)

## 8 理解内存

### 8.1 内存消耗

1、内存消耗分为进程自身消耗和子进程消耗

![](../.gitbook/assets/image%20%2888%29.png)

2、对象内存：

```text
redis 内存占用最大的一块。
```

3、缓冲内存

主要包括：客户端缓冲、复制积压缓冲区、AOF缓冲区。

客户端缓冲：是指所有接入到Redis服务器TCP连接的输入输出缓冲。

复制积压缓冲区：该缓冲区用来实现部分复制功能

AOF缓冲区：用于在Redis重写期间保存最近写入的命令。

4、内存碎片：

内存分配器为了更好地管理和重复利用内存，分配内存策略一般采用固定范围的内存块进行分配。一般分配器都会有内存碎片。

内存碎片的解决办法：

（1）数据对齐

（2）安全重启：重启节点可以做到内存碎片重新整理。

5、子进程内存消耗

子进程内存消耗主要是指执行AOF/RDB重写时Redis创建的子进程内存消耗。



### 8.2 内存管理

Redis主要通过控制内存上限和回收策略实现内存管理。

#### 8.2.1 设置内存上限

只能限制实际使用的内存量，不包含内存碎片。



#### 8.2.2 回收

1、删除过期键对象

惰性删除

定时任务删除

2、内存溢出控制策略

当所用内存达到maxmemory 上限时，会触发相应的溢出控制策略。



### 8.3 内存优化

#### 8.3.1 redisObject 对象

![](../.gitbook/assets/image%20%2889%29.png)

type： 对外的5种类型

encoding：内部编码类型

lru：记录对象最后一次被访问的时间

refcount: 记录当前对象被引用的次数，当refcount=0时，被回收。

ptr：与对象的数据内容相关，如果是整数，直接存储数据；否则表示指向数据的指针。

#### 8.3.2 缩减键值对象

降低redis 内存使用最直接的方式就是缩减键和值的长度。

key 长度：在完整描述业务情况下，键值越短越好。

value 长度：可以采用压缩的方式存储。

#### 8.3.3 共享对象池

共享内存池是指Redis内部维护\[0-9999\] 的整数对象池，用于节约内存。因此开发中在满足需求的前提下，尽量使用整数对象以节省内存。

为什么只有整数对象池？

> 首先整数对象池复用的几率最大，其次对象共享的一个关键操作就是判断相等性，Redis 之所以只有整数对象池，是因为整数比较算法为o\(1\),  只保留一万个整数为了防止对象池浪费。其他类型的比对，时间复杂度高。

#### 8.3.4 字符串优化

Redis 中值对象除了整数之外，都是使用的字符串存储。

1、字符串结构：

![](../.gitbook/assets/image%20%2890%29.png)

> O\(1\) 时间复杂度获取：字符串长度、已用长度、未用长度；
>
> 可用于保存字节数组，支持安全的二进制数据存储
>
> 内部实现空间预分配机制，降低内存再分配次数
>
> 惰性删除：字符串缩减后的空间不释放，作为预分配空间保留。

2、预分配机制

字符串之所以采用预分配的方式是防止修改操作需要不断重分配内存和字节数据拷贝。但同样也会造成内存的浪费。

字符串预分配每次并不都是翻倍扩容。

3、字符串重构

指不一定把每份数据作为字符串整体存储。同时，可以使用使用hmget/hmset 命令支持字段的部分读取修改，而不用每次整体存取。

#### 8.3.5 编码优化

通过不同的编码实现效率和空间的平衡。

#### 8.3.6 控制键的数量

比如 通过hash 和 ziplist 来减少key 的数量。就是使用hash 中的field 来减少key 的数量。



## 9 哨兵



## 10 集群



## 11 缓存设计



## 12 开发运维的坑

