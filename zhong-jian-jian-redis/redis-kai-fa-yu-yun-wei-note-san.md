# Redis开发与运维-note\(三\)

## 8 理解内存

### 8.1 内存消耗

1、内存消耗分为进程自身消耗和子进程消耗

![](../.gitbook/assets/image%20%2888%29.png)

2、对象内存：

```text
redis 内存占用最大的一块。
```

3、缓冲内存

主要包括：客户端缓冲、复制积压缓冲区、AOF缓冲区。

客户端缓冲：是指所有接入到Redis服务器TCP连接的输入输出缓冲。

复制积压缓冲区：该缓冲区用来实现部分复制功能

AOF缓冲区：用于在Redis重写期间保存最近写入的命令。

4、内存碎片：

内存分配器为了更好地管理和重复利用内存，分配内存策略一般采用固定范围的内存块进行分配。一般分配器都会有内存碎片。

内存碎片的解决办法：

（1）数据对齐

（2）安全重启：重启节点可以做到内存碎片重新整理。

5、子进程内存消耗

子进程内存消耗主要是指执行AOF/RDB重写时Redis创建的子进程内存消耗。



### 8.2 内存管理

Redis主要通过控制内存上限和回收策略实现内存管理。

#### 8.2.1 设置内存上限

只能限制实际使用的内存量，不包含内存碎片。



#### 8.2.2 回收

1、删除过期键对象

惰性删除

定时任务删除

2、内存溢出控制策略

当所用内存达到maxmemory 上限时，会触发相应的溢出控制策略。



### 8.3 内存优化

#### 8.3.1 redisObject 对象

![](../.gitbook/assets/image%20%2889%29.png)

type： 对外的5种类型

encoding：内部编码类型

lru：记录对象最后一次被访问的时间

refcount: 记录当前对象被引用的次数，当refcount=0时，被回收。

ptr：与对象的数据内容相关，如果是整数，直接存储数据；否则表示指向数据的指针。

#### 8.3.2 缩减键值对象



#### 8.3.3 共享对象池



#### 8.3.4 字符串优化



#### 8.3.5 编码优化



#### 8.3.6 控制键的数量





## 9 哨兵



## 10 集群



## 11 缓存设计



## 12 开发运维的坑

