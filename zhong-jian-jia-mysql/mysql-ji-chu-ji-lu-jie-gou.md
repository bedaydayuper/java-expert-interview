# MySQL基础-记录结构

## 1 InnoDB 记录存储结构

### 1.1 InnoDB 页 

一条条从磁盘读取到内存比较慢，所以使用页，以页作为磁盘与内存交互的基本单位。

### 1.2 InnoDB 行格式

1、有四种行格式：compact、redundant、dynamic、compressed。

### 1.3 compact  格式

变长列表

![](../.gitbook/assets/image%20%28142%29.png)

![](../.gitbook/assets/image%20%28147%29.png)

NULL值列表

```text
1、统计表中允许存储NULL 的列有哪些
2、如果没有允许NULL的列，则NULL值列表也就不存在了。否则允许每个允许存储NULL的列对应
一个二进制位。
3、NULL值列表必须使用整数个字节的位表示，如果不足一字节，则补齐。
```

记录头信息： 由固定的5个字节组成。

![](../.gitbook/assets/image%20%28139%29.png)

![](../.gitbook/assets/image%20%28143%29.png)

记录的真实数据

除了自定义的数据之外，MySQL会为每个记录默认的添加一些列（也成为隐藏列）。

![](../.gitbook/assets/image%20%28150%29.png)

InnoDB主键的生成策略：

```text
优先使用用户自定义主键作为主键，
如果用户没有定义主键，则选取一个Unique键作为主键，
如果表中连Unique键都没有定义的话，则InnoDB会为表默认添加一个名为row_id的隐藏列作为主键。


```

增加了隐藏列之后，行记录是这样的：

![](../.gitbook/assets/image%20%28144%29.png)

**CHAR\(M\)列的存储格式：**

对于 _**CHAR\(M\)**_ 类型的列来说，当列采用的是定长字符集时，该列占用的字节数不会被加到变长字段长度列表，而如果采用变长字符集时，该列占用的字节数也会被加到变长字段长度列表。

### 1.4 行溢出数据-**VARCHAR\(M\)最多能存储的数据**

`VARCHAR(M)`类型的列最多可以占用`65535`个`字节`，其中M代表最多存储的`字符`数量   。

MySQL 对一条记录占用的最大存储空间是有限制的，除了BLOB 或者TEXT 类型的列之外，其他所有列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过65535个字节。

其实需要占用3部分存储空间：

* 真实数据
* 真实数据占用字节的长度
* `NULL`值标识，如果该列有`NOT NULL`属性则可以没有这部分存储空间

如果该`VARCHAR`类型的列没有`NOT NULL`属性，那最多只能存储`65532`个字节的数据，因为真实数据的长度可能占用2个字节，`NULL`值标识需要占用1个字节。

```text
述所言在列的值允许为NULL的情况下，gbk字符集下M的最大取值就是32766，
utf8字符集下M的最大取值就是21844，这都是在表中只有一个字段的情况下说的，
一定要记住一个行中的所有列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过65535个字节！
```

疑问：

1、行长度会计算 text 跟 blob 类型的字段吗？？？

2、如果不包含，那text 跟 blob 怎么处理？？？

不只是 _**VARCHAR\(M\)**_ 类型的列，其他的 _**TEXT**_、_**BLOB**_ 类型的列在存储数据非常多的时候也会发生`行溢出`。



## 2 InnoDB 数据页结构

InnoDB 都是以页为基本单位存放数据的。

### 2.1 数据页结构速览

![](../.gitbook/assets/image%20%28146%29.png)

![](../.gitbook/assets/image%20%28145%29.png)

![](../.gitbook/assets/image%20%28140%29.png)

### 2.2 页目录

查找记录时使用。

```text
1、将所有正常的记录（包括最大和最小记录，不包括标记为已删除的记录）划分为几个组。

2、每个组的最后一条记录（也就是组内最大的那条记录）的头信息中的n_owned属性表示该记录拥有多少条记录，
也就是该组内共有几条记录。

3、将每个组的最后一条记录的地址偏移量单独提取出来按顺序存储到靠近页的尾部的地方，
这个地方就是所谓的Page Directory，也就是页目录（此时应该返回头看看页面各个部分的图）。
页面目录中的这些地址偏移量被称为槽（英文名：Slot），所以这个页面目录就是由槽组成的。
```

![](../.gitbook/assets/image%20%28149%29.png)





设计`InnoDB`的大叔们对每个分组中的记录条数是有规定的：对于最小记录所在的分组只能有 _**1**_ 条记录，最大记录所在的分组拥有的记录条数只能在 _**1~8**_ 条之间，剩下的分组中记录的条数范围只能在是 _**4~8**_ 条之间。所以分组是按照下边的步骤进行的：

* 初始情况下一个数据页里只有最小记录和最大记录两条记录，它们分属于两个分组。
* 之后每插入一条记录，都会从`页目录`中找到主键值比本记录的主键值大并且差值最小的槽，然后把该槽对应的记录的`n_owned`值加1，表示本组内又添加了一条记录，直到该组中的记录数等于8个。
* 在一个组中的记录数等于8个后再插入一条记录时，会将组中的记录拆分成两个组，一个组中4条记录，另一个5条记录。这个过程会在`页目录`中新增一个`槽`来记录这个新增分组中最大的那条记录的偏移量。

### 2.3 在数据页中查找记录

一个数据页中查找指定主键值的记录的过程分为两步：

1. 通过二分法确定该记录所在的槽，并找到该槽所在分组中主键值最小的那条记录。
2. 通过记录的`next_record`属性遍历该槽所在的组中的各个记录。



### 2.4 Page Header （数据页的通用信息）

记录一个数据页中存储的记录的状态信息。比如当前页存储了多少记录，第一条记录的地址，页目录中有多少个槽等。

![](../.gitbook/assets/image%20%28141%29.png)



### 2.5 File Header \(文件头部\)  各种类型的页都通用

页的通用信息。比如这个页的编号，它的上一个页，下一个页是谁等等。

![](../.gitbook/assets/image%20%28148%29.png)

### 2.6 File Trailer

由`8`个字节组成，可以分成2个小部分：

```text
前4个字节代表页的校验和
后4个字节代表页面被最后修改时对应的日志序列位置（LSN）
```

## 3 B+ 树索引



## 4 B+ 树索引的使用



## 5 MySQL的数据目录

## 

## 6 InnoDB的表空间

## 

  

