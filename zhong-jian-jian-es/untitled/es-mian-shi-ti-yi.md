# ES 面试题（三）调优

## 1 调优相关

### 1.1 设计阶段调优



> （1）根据业务增量需求，采取基于日期模板创建索引，通过 roll over API 滚动索引；
>
> （2）使用别名进行索引管理；
>
> （3）每天凌晨定时对索引做 force\_merge 操作，以释放空间；
>
> （4）采取冷热分离机制，热数据存储到 SSD，提高检索效率；冷数据定期进行 shrink操作，以缩减存储；
>
> （5）采取 curator 进行索引的生命周期管理；
>
> （6）仅针对需要分词的字段，合理的设置分词器；
>
> （7）Mapping 阶段充分结合各个字段的属性，是否需要检索、是否需要存储等。



### 1.2 写入调优



> （1）写入前副本数设置为 0；
>
> （2）写入前关闭 refresh\_interval 设置为-1，禁用刷新机制；
>
> （3）写入过程中：采取 bulk 批量写入；
>
> （4）写入后恢复副本数和刷新间隔；
>
> （5）尽量使用自动生成的 id。

### 1.3 查询调优

> （1）禁用 wildcard；
>
> （2）禁用批量 terms（成百上千的场景）；
>
> （3）充分利用倒排索引机制，能 keyword 类型尽量 keyword；
>
> （4）数据量大时候，可以先基于时间敲定索引再检索；
>
> （5）设置合理的路由机制。

### 1.4 大数据量调优

#### 1.4.1 filesystem

![](../../.gitbook/assets/image%20%2841%29.png)

ES 的搜索引擎严重依赖于底层的 Filesystem Cache，你如果给 Filesystem Cache 更多的内存，尽量让内存可以容纳所有的 IDX Segment File 索引数据文件，那么你搜索的时候就基本都是走内存的，性能会非常高。

归根结底，你要让 ES 性能好，最佳的情况下，就是你的机器的内存，至少可以容纳你的总数据量的一半。



#### 1.4.2 数据预热

每隔一段时间，将热数据 手动在后台查询一遍，将热数据刷新到fileSystem cache上。

#### 1.4.3  冷热分离

将热数据单独建立一个索引。

#### 1.4.4  document 设计

在使用es时 避免使用复杂的查询语句（Join 、聚合），就是在建立索引时， 就根据查询语句建立好对应的元数据。  


#### 1.4.5 分页性能优化

> #### **千万不要深分页。可以采用scroll\(scroll 方案中，如果不需要排序，则考虑增加** ，将 search\_type 设置成 Scan,  Scroll-Scan 关闭了 Scroll 中最耗时的文本相似度计算和排序，使得性能更加高效。 **\)。或者search after 方案**

注意：Elasticsearch 2.1.0 版本之后移除了 search\_type=scan，使用 "sort": \[ "\_doc"\] 进行代替。

## 



## 参考文献：

```text
调优相关
https://juejin.cn/post/6844903855746973703
https://aijishu.com/a/1060000000095403
https://zhuanlan.zhihu.com/p/67600167
https://bbs.huaweicloud.com/blogs/141349

```

