# ES 面试题（二）集群管理与读写流程

## 1 集群启动

### 1.1 启动流程

![&#x542F;&#x52A8;](../../.gitbook/assets/image%20%2840%29.png)

### 1.2 确定主节点

对节点ID 排序，谁大谁是master。

基于 节点排序的简单选举有三个附加的约束条件：

* 参选人数过半
* 得票人数过半
* 当节点离开时，必须判断当前节点数是否过半。

![&#x9009;&#x4E3B;&#x5168;&#x6D41;&#x7A0B;](../../.gitbook/assets/image%20%2837%29.png)

![&#x9009;&#x4E3E;&#x4E34;&#x65F6;master](../../.gitbook/assets/image%20%2838%29.png)

![&#x786E;&#x7ACB;master](../../.gitbook/assets/image%20%2836%29.png)

![&#x5B9A;&#x671F;&#x68C0;&#x67E5;](../../.gitbook/assets/image%20%2842%29.png)

### 1.3 选举元信息

1.3.1 读写并不经过 master 节点，所以master节点需要收集元信息。

1.3.2 集群元信息（一些状态信息）选举之后，master 发布首次集群状态，然后开始选举shard 级元信息。

### 1.4 确定主分片

选举shard级的元信息，构建内容路由表

包括  主分片和副分片。

主分片的确定由master节点决定。

### 1.5 主副分片恢复

#### 1.5.1 主分片恢复

借助事务日志，进行重放，如此完成主分片的恢复。

#### 1.5.2 副分片恢复

划分了两个阶段：  


![](../../.gitbook/assets/image%20%2839%29.png)



## 2 单个节点的启动与关闭



## 3倒排索引



## 4 读写

## 5 master 选举

## 6 脑裂问题 



## 参考文献：



